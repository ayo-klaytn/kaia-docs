# 2. GA 작동 방식: 기술 심층 분석

이 섹션에서는 트랜잭션 번들링, 원자성, 주요 구성 요소의 역할 등 카이아 네트워크 내에서 가스 추상화가 작동하는 방식에 대한 자세한 기술 개요를 제공합니다.

## 2.1 아키텍처 개요

GA는 스마트 계약과 거래 번들링을 활용하여 원활한 사용자 경험을 보장하는 탈중앙화 아키텍처를 기반으로 구축되었습니다.

### 주요 구성 요소

- **[KIP-247(가스 없는 트랜잭션)](https://kips.kaia.io/KIPs/kip-247):** 네트워크가 가스 추상화에 적합한 것으로 인식하는 특정 트랜잭션 형식(`GaslessApproveTx`, `GaslessSwapTx`)을 정의합니다.
- \*\*[KIP-245 (트랜잭션 번들)](https://kips.kaia.io/KIPs/kip-245): \*\* 필요한 트랜잭션 순서(대출, 승인, 스와핑)가 **원리적으로** 실행되도록 보장합니다(모두 성공하거나 모두 함께 실패).
- **[가스리스스왑라우터(GSR)](https://github.com/kaiachain/kaia/blob/v2.0.3/contracts/contracts/system_contracts/kip247/GaslessSwapRouter.sol):** 토큰-카이아 스왑을 수행하고 블록 제안자에게 초기 가스 대출을 상환하는 핵심 스마트 컨트랙트로, 모두 동일한 블록 내에서 이루어집니다.

### 주요 행위자

다음 다이어그램은 GA 프로세스의 주요 행위자와 이들의 상호 작용을 보여줍니다:

![](/img/build/tutorials/ga1.png)

- **지갑**: 가스 없는 트랜잭션을 시작하는 사용자의 지갑 또는 디앱 인터페이스입니다.
- **사용자 계정**: 가스 없는 트랜잭션을 시작하는 지갑 또는 디앱 사용자입니다.
- **블록 제안자**: 블록을 제안하는 노드로, 가스비를 위해 KAIA를 일시적으로 빌려주는 노드입니다.
- **가스리스스왑라우터(GSR)**: 스왑 및 상환 로직을 처리하는 스마트 컨트랙트입니다.
- **DEX 라우터**: 실제 토큰 스왑을 수행하는 기본 탈중앙화 거래소입니다.

## 2.2 트랜잭션 번들 구성 요소

GA는 **거래 번들링**을 통해 작동하며, 블록체인 클라이언트는 **LendTx + (선택 사항) ApproveTx + SwapTx**만 \*\*원자 번들로 그룹화합니다. 이 세 가지가 모두 성공하거나 모두 실패합니다. 번들 직후에 전송된 모든 **AppTx**는 번들 _외부_에 있으며 독립적으로 되돌릴 수 있습니다.

![](/img/build/tutorials/ga2.png)

### LendTx(렌드 트랜잭션)

- **서명자**: 블록 제안자
- **목적**: 가스 요금으로 사용자에게 일시적으로 KAIA를 대여합니다.
- **생성**: 블록 생성 중 [동적으로 생성](https://github.com/kaiachain/kaia/blob/v2.0.3/kaiax/gasless/impl/getter.go#L267)
- **금액**: ApproveTx + SwapTx에 대한 가스를 충당하기 위해 계산된 금액입니다.

### ApproveTx(승인 트랜잭션) - 선택 사항

- **서명자**: 사용자
- **목적**: 가스리스스왑라우터에 대한 ERC-20 토큰 지출을 승인합니다.
- **필요할 때**: 사용자가 이전에 토큰을 승인하지 않은 경우
- **포맷**: KIP-247 규격](https://kips.kaia.io/KIPs/kip-247)을 따라야 합니다.

### SwapTx(스왑 거래)

- **서명자**: 사용자
- **목적**: 사용자 토큰을 KAIA로 교환하고 제안자에게 상환합니다.
- **계약**: 가스리스스왑라우터.sol](https://github.com/kaiachain/kaia/blob/v2.0.3/contracts/contracts/system_contracts/kip247/GaslessSwapRouter.sol)을 호출합니다.
- **유효성 검사**: '금액 수령 >= 최소 금액 출력 >= 금액 지불'을 확인합니다.

## 2.3 원자성 및 장애 처리

**KIP-245 번들 속성:**

- **전부 또는 전무 실행**: 트랜잭션이 실패하면 전체 번들이 되돌아갑니다.
- **타임아웃 면제**: 번들은 블록당 250ms 실행 제한이 면제됩니다.
- **상태 롤백**: 실패한 번들은 완전한 상태 되돌리기를 트리거합니다.

**일반적인 실패 시나리오:**

- 토큰 잔액 부족 → 번들 되돌리기, 가스 손실 없음
- 가격 미끄러짐 초과 → SwapTx 실패, 번들 되돌리기
- 토큰 승인 누락 → 유효성 검사 실패, 트랜잭션이 풀에 남아 있음

## 2.4 네트워크 수준 처리

**거래 풀 유효성 검사**

가스 없는 트랜잭션은 트랜잭션 풀의 일반적인 잔액 확인을 우회합니다. 유효성 검사 로직은 무가스 거래를 감지하여 가스 요금에 대한 계정 잔액 확인을 생략합니다.

**프로모션 및 번들링 로직**

- 해당 가스리스스왑이 없으면 가스리스앱승인Tx를 승격할 수 없습니다.
- 토큰이 이미 승인된 경우 가스리스스왑Tx는 독립적으로 승격될 수 있습니다.
- 두 거래가 모두 존재하면 두 거래가 동시에 승격됩니다.

**제안자 주입 및 실행 차단**

블록 제안자는 가스 없는 트랜잭션을 감지하면 자동으로 LendTx를 주입합니다. LendTx는 블록 생성 중에 즉석에서 생성되어 사용자의 가스 없는 트랜잭션 앞에 배치됩니다.

## 2.5 잔액 변경이 있는 워크플로 예시

사용자가 `1.00 BORA`와 `0 KAIA`를 보유하고 있는 시나리오를 살펴보겠습니다.

| 단계                                        | 액션                                                                                | 제안자 균형                         | 사용자 잔액                                                | 참고                                                                        |
| :---------------------------------------- | :-------------------------------------------------------------------------------- | :----------------------------- | :---------------------------------------------------- | :------------------------------------------------------------------------ |
| 1. 이니셜             | -                                                                                 | 10.00 KAIA     | 0.00 카이아, 1.00 보라     | 사용자가 TX 비용을 지불하려고 합니다.                                    |
| 2. **`LendTx`**    | 제안자가 0.02 KAIA를 빌려줍니다.                            | 9.97 KAIA      | 0.02 카이아, 1.00 보라     | 제안자는 자체 가스를 지불합니다.                                        |
| 3. **`ApproveTx`** | 사용자가 GSR용 BORA를 승인합니다.                                            | 9.97 KAIA      | 0.01 카이아, 1.00 보라     | 대출로 지불한 가스(0.01 KAIA). |
| 4. **SwapTx\`**    | 사용자가 0.06 BORA를 0.04 KAIA로 교환합니다. | **10.00 KAIA** | **0.01 카이아**, 0.94 보라 | 제안자는 0.03 KAIA를 상환받습니다.                   |
| 5. **`AppTx`**     | 사용자가 기본 tx를 실행합니다.                                                | 10.00 KAIA     | 0.00 카이아, 0.94 보라     | 스왑을 통해 KAIA로 지불한 가스.                                      |
